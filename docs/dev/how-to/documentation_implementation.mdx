# Product documentation implementation

The [documentation guidelines](https://handbook.sourcegraph.com/engineering/product_documentation) apply to product documentation. This page has information specific to this repository's documentation.

## Documentation directory structure

<!-- Needs Review -->

The documentation is broken down into 3 different areas:

1. User
1. Admin
1. Development

Each of these areas has the docs organized by the 4 different types:

1. Tutorials
1. How-to guides
1. Explanation or background information
1. Reference

This structure is inspired by the [Divio documentation system](https://documentation.divio.com/).

## Previewing changes locally

Our docs are managed in the [sourcegraph/docs](https://github.com/sourcegraph/docs) repository. To preview changes locally, you can run the docs app locally:
```sh
git clone https://github.com/sourcegraph/docs.git sourcegraph-docs
```

Navigate to the project directory by typing the following command in your terminal:

```sh
cd sourcegraph-docs
```

Before the dependencies are install make sure your local machine has the following versions of `node` and `pnpm`:

* node: `v20.8.1`
* pnpm: `8.13.1`

**Note**: If you have `asdf` available you can install the above versions for only this repository by running the following command from your terminal in the root folder:

```sh
asdf install
```

Now that the base requirements of the project have been satisfied, we can install the required dependencies to run the development server!

```sh
pnpm install
```

Next, run the development server:

```sh
pnpm run dev
```
Finally, open [`http://localhost:3000`](http://localhost:3000) in your browser to view the website.

## Linking to documentation in-product

To add a `link` to any docs page, use the following routing syntax: `[Link text](path-to-link)`.

- Do not include `/docs` in the link paths. The base URL will be `sourcegraph.com/docs`
- There should be **no file extension** in the path name

For example, if you want to link to the Cody Quickstart somewhere in the Code Search docs, you should use:

```markdown
- This is a link to [Cody Quickstart](/cody/quickstart) in Code Search docs
- This is a way to hash-link to [Cody for VSCode installation](/cody/clients/install-vscode#verifying-the-installation) in Code Search docs
```

## Adding images to the documentation

For large images and other binary assets, upload them to the `sourcegraph-assets` Google Cloud Storage bucket instead with `gsutil cp -a public-read local/path/to/myasset.png gs://sourcegraph-assets/` (and refer to them as `https://sourcegraphstatic.com/myasset.png`). For a more detailed instructions visit [this page](https://handbook.sourcegraph.com/handbook/editing/handbook-images-video/).

> Note: Make sure to use [ImageOptim.app](https://imageoptim.com/mac) to reduce the size of the images before uploading, since large images degrade page loading speed.

## Updating documentation

<!-- Needs Review -->

To update documentation content, templates, or assets on https://docs.sourcegraph.com, push changes in the `doc/` directory to this repository's `main` branch, then wait up to 5 minutes. Every 5 minutes, docs.sourcegraph.com reloads all content, templates, and assets from `main`.

- Documentation content lives in `doc/**/*.md`.
- The sidebar lives in `doc/sidebar.md`. Only important pages belong in the sidebar; use section index page links for other documents.
- Assets and templates live in `doc/_resources/{templates,assets}`.

Updates to the redirects in `doc/_resources/assets/redirects` require a full reload of the service, which involves deleting the relevant Kubernetes pods. See ["Forcing immediate reload of data"](#forcing-immediate-reload-of-data) for more details.

## SEO

<!-- Needs Review -->

Every markdown document can be prefixed with front matter, which comes with a specific set of fields that are used
to generate metatags and opengraph tags that improve our ranking. The excerpt below highlights all available fields, which are all optional. Invalid fields will raise an error at runtime but can be caught ahead by running `docsite check`

```
---
title: "That current page title"
description: "A brief description of what that page is about"
category: "Which category of the content does this belong"
type: "article (will default to website otherwise)"
imageURL: "https://sourcegraph.com/.assets/img/sourcegraph-logo-dark.svg"
tags:
  - A list of tags such as
  - Code Search
  - How to
---

# My markdown title

My content
```

See [the Open Graph protocl](https://ogp.me) to learn more about these tags.

## Forcing immediate reload of data

<!-- Needs Review -->

The docs.sourcegraph.com site reloads content, templates, and assets every 5 minutes. After you push a [documentation update](#updating-documentation), just wait up to 5 minutes to see your changes reflected on docs.sourcegraph.com.

If you need to force a reload — either because your change is _extremely_ urgent and can't wait 5 minutes, or because you've updated redirects — you can delete the `docs-sourcegraph-com-*` Kubernetes pod on the Sourcegraph.com Kubernetes cluster. Once done, it will restart and come back online with the latest data.

>WARNING: There may be a few seconds of downtime when restarting the docs cluster this way. This shouldn't be a routine part of your workflow!

To do this, follow the ["Restarting sourcegraph.com and docs.sourcegraph.com" playbook](https://handbook.sourcegraph.com/departments/engineering/dev/process/deployments/playbooks/#restarting-docssourcegraphcom).

## Other ways of previewing changes locally (very rare)

<!-- Needs Review -->

The [local documentation server](#previewing-changes-locally) on http://localhost:5080 only serves a single version of the documentation (from the `doc/` directory of your working tree). This usually suffices.

In very rare cases, you may want to run a local documentation server with a different configuration (described in the following sections).

### Running a local server that mimics prod configuration

<!-- Needs Review -->

If you want to run the doc site *exactly* as it's deployed (reading templates and assets from the remote Git repository, too), consult the current Kubernetes deployment spec and invoke `docsite serve` with the deployment's `DOCSITE_CONFIG` env var, the end result looking something like:

```bash
DOCSITE_CONFIG=$(cat <<-'DOCSITE'
{
  "templates": "https://codeload.github.com/sourcegraph/sourcegraph/zip/docsite-fallback#*/doc/_resources/templates/",
  "assets": "https://codeload.github.com/sourcegraph/sourcegraph/zip/docsite-fallback#*/doc/_resources/assets/",
  "content": "https://codeload.github.com/sourcegraph/sourcegraph/zip/refs/heads/$VERSION#*/doc/",
  "defaultContentBranch": "docsite-fallback",
  "baseURLPath": "/",
  "assetsBaseURLPath": "/assets/"
}
DOCSITE
) docsite serve -http=localhost:5081
```

You can test your changes alongside prod configuration (including things like multi-version support, i.e. `/@version/content`) by pushing your changes to a branch (e.g. `my-branch`) and run the above command after replacing all instances of `main` with `my-branch`.
